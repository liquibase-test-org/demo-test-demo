name: Liquibase Deploy

on:
  push:
    branches: [main]
    paths:
      - 'liquibase/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment || 'dev' }}
    runs-on: ${{ vars.LIQUIBASE_RUNNER_LABEL || 'ubuntu-latest' }}
    environment: ${{ inputs.environment || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for pre-installed Liquibase
        id: check-liquibase
        run: |
          if command -v liquibase &> /dev/null; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "✅ Liquibase is pre-installed: $(liquibase --version | head -1)"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "⚠️ Liquibase not found, will install via setup-liquibase"
          fi

      - name: Setup Liquibase
        if: steps.check-liquibase.outputs.found != 'true'
        uses: liquibase/setup-liquibase@v2
        with:
          version: '5.0.0'
          edition: 'secure'

      - name: Set environment variables
        id: env
        run: |
          ENV_NAME="${{ inputs.environment || 'dev' }}"
          ENV_UPPER=$(echo "$ENV_NAME" | tr '[:lower:]' '[:upper:]')
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "env_upper=$ENV_UPPER" >> $GITHUB_OUTPUT

      - name: Run Liquibase Update
        working-directory: liquibase
        env:
          LIQUIBASE_LICENSE_KEY: ${{ secrets.LIQUIBASE_LICENSE_KEY }}
          LIQUIBASE_URL: ${{ secrets[format('LIQUIBASE_{0}_URL', steps.env.outputs.env_upper)] }}
          LIQUIBASE_USERNAME: ${{ secrets[format('LIQUIBASE_{0}_USERNAME', steps.env.outputs.env_upper)] }}
          LIQUIBASE_PASSWORD: ${{ secrets[format('LIQUIBASE_{0}_PASSWORD', steps.env.outputs.env_upper)] }}
          LIQUIBASE_SCHEMA: ${{ secrets[format('LIQUIBASE_{0}_SCHEMA', steps.env.outputs.env_upper)] }}
        run: |
          # Build command array to safely handle special characters
          ARGS=(
            "liquibase"
            "update"
            "--changelog-file=changelog.xml"
            "--url=$LIQUIBASE_URL"
            "--username=$LIQUIBASE_USERNAME"
            "--password=$LIQUIBASE_PASSWORD"
          )

          # Only add schema parameters if LIQUIBASE_SCHEMA is set
          if [ -n "$LIQUIBASE_SCHEMA" ]; then
            ARGS+=("--liquibase-schema-name=$LIQUIBASE_SCHEMA")
            ARGS+=("--default-schema-name=$LIQUIBASE_SCHEMA")
          fi

          # Execute with array expansion (properly handles special characters)
          "${ARGS[@]}"

      - name: Create deployment artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-${{ steps.env.outputs.env_name }}-${{ github.run_number }}
          path: |
            liquibase/changelog.xml
            liquibase/changelogs/
          retention-days: 90
